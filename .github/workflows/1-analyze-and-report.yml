# .github/workflows/1-analyze-and-report.yml

name: 'Reuseable: Analyze and Report'

# ====================================================================
# TRIGGER:
# 1. Kann von einem anderen Workflow aufgerufen werden (für die CI-Pipeline).
# 2. Kann manuell gestartet werden
# ====================================================================
on:
  workflow_dispatch:
  workflow_call:

permissions:
  id-token: write
  contents: read


jobs:
  # ====================================================================
  # JOB 1: ANALYZE
  # Dieser Job führt die lesenden Operationen auf Azure aus.
  # ====================================================================
  analyze:
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout code'
        uses: actions/checkout@v6

      - name: 'Read configuration from finops.config.json'
        id: config
        run: |
          {
            echo "unattached_disks_enabled=$(jq -r '.analysis_modules.unattached_disks.enabled' finops.config.json)"
            echo "unassociated_public_ips_enabled=$(jq -r '.analysis_modules.unassociated_public_ips.enabled' finops.config.json)"
            echo "old_snapshots_enabled=$(jq -r '.analysis_modules.old_snapshots.enabled' finops.config.json)"
            echo "azure_advisor_enabled=$(jq -r '.analysis_modules.azure_advisor.enabled' finops.config.json)"
          } >> "$GITHUB_OUTPUT"

      - name: 'Azure Login'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # --------------------------------------------------------------------
      # ANALYSE-MODULE
      # Jeder der folgenden Schritte ist ein eigenständiges Analyse-Modul.
      # Die Ausführung wird über die 'finops.config.json'-Datei gesteuert.
      # --------------------------------------------------------------------

      - name: 'Module: Find unattached disks'
        # KORRIGIERTE IF-BEDINGUNG: Greift auf den Output des 'config'-Schritts zu
        if: steps.config.outputs.unattached_disks_enabled == 'true'
        run: |
          EXCLUSION_FILTER=""
          for rg in $(jq -r '.global_settings.excluded_resource_groups[]' finops.config.json); do
            EXCLUSION_FILTER+="&& resourceGroup!='$rg'"
          done
          
          az disk list --query "[?diskState=='Unattached' $EXCLUSION_FILTER].{Name:name, ResourceGroup:resourceGroup, SizeGB:diskSizeGb, Location:location}" --output tsv > analysis-unattached-disks.tsv || true
          echo "Found $(wc -l < analysis-unattached-disks.tsv) unattached disks."

      - name: 'Module: Find unassociated public IPs'
        if: steps.config.outputs.unassociated_public_ips_enabled == 'true'
        run: |
          EXCLUSION_FILTER=""
          for rg in $(jq -r '.global_settings.excluded_resource_groups[]' finops.config.json); do
            EXCLUSION_FILTER+="&& resourceGroup!='$rg'"
          done

          az network public-ip list --query "[?ipConfiguration==null $EXCLUSION_FILTER].{Name:name, ResourceGroup:resourceGroup, IPAddress:ipAddress, Location:location}" --output tsv > analysis-unassociated-public-ips.tsv || true
          echo "Found $(wc -l < analysis-unassociated-public-ips.tsv) unassociated public IPs."

      - name: 'Module: Find old snapshots'
        if: steps.config.outputs.old_snapshots_enabled == 'true'
        run: |
          RETENTION_DAYS=$(jq -r '.analysis_modules.old_snapshots.retention_days' finops.config.json)
          cutoff_date=$(date -d "-$RETENTION_DAYS days" -u +'%Y-%m-%dT%H:%M:%SZ')
          
          EXCLUSION_FILTER=""
          for rg in $(jq -r '.global_settings.excluded_resource_groups[]' finops.config.json); do
            EXCLUSION_FILTER+="&& resourceGroup!='$rg'"
          done

          az snapshot list --query "[?timeCreated < '$cutoff_date' $EXCLUSION_FILTER].{Name:name, ResourceGroup:resourceGroup, SizeGB:diskSizeGb, Location:location}" --output tsv > analysis-old-snapshots.tsv || true
          echo "Found $(wc -l < analysis-old-snapshots.tsv) snapshots older than $RETENTION_DAYS days."

      - name: 'Module: Get Azure Advisor recommendations'
        if: steps.config.outputs.azure_advisor_enabled == 'true'
        run: |
          CATEGORIES=$(jq -r '.analysis_modules.azure_advisor.categories | join(" ")' finops.config.json)

          az advisor recommendation list --category "$CATEGORIES" --query "[].{Description:shortDescription.problem, Resource:resourceMetadata.resourceId, Category:category}" --output tsv > analysis-azure-advisor-recommendations.tsv || true
          echo "Found $(wc -l < analysis-azure-advisor-recommendations.tsv) Advisor recommendations for categories: \"$CATEGORIES\"."

      # --------------------------------------------------------------------
      # WORKFLOW-ABSCHLUSS
      # --------------------------------------------------------------------

      - name: 'Upload analysis results as artifact'
        uses: actions/upload-artifact@v4
        with:
          name: finops-analysis-results
          path: analysis-*.tsv
          if-no-files-found: ignore

      - name: 'Azure Logout'
        run: |
          az logout
          az cache purge
          az account clear

  # ====================================================================
  # JOB 2: REPORT
  # Dieser Job wartet auf den Analyse-Job und erstellt den Report.
  # ====================================================================
  report:
    runs-on: ubuntu-latest
    # 'needs: analyze' stellt sicher, dass dieser Job erst nach erfolgreichem Abschluss des 'analyze'-Jobs startet.
    needs: analyze

    steps:
      - name: 'Checkout code'
        uses: actions/checkout@v6

      - name: 'Download analysis results'
        uses: actions/download-artifact@v4
        with:
          name: finops-analysis-results

      - name: 'Generate Markdown Report'
        run: |
          chmod +x .github/scripts/generate-report.sh
          ./.github/scripts/generate-report.sh

      - name: 'Upload final report'
        uses: actions/upload-artifact@v4
        with:
          name: finops-cost-report
          path: report.md
          if-no-files-found: error
