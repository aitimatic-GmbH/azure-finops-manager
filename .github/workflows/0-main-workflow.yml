# .github/workflows/0-main-workflow.yml

name: 'Reusable - FinOps Analyze and Report'

on:
  push:
    branches-ignore:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
  workflow_call:
    inputs:
      config-path:
        description: 'Path to the finops.config.json file'
        required: true
        type: string
    secrets:
      AZURE_CLIENT_ID:
        required: true
      AZURE_TENANT_ID:
        required: true
      AZURE_SUBSCRIPTION_ID:
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  # ====================================================================
  # JOB 1: LINTING (Nummeriert für korrekte UI-Sortierung)
  # ====================================================================
  lint-workflows: # JOB-ID wurde umbenannt
    name: 'Quality Gate: Linting'
    uses: ./.github/workflows/2-lint-workflows.yml

  # ====================================================================
  # JOB 2: MOCK-DATEN-TEST (Nummeriert für korrekte UI-Sortierung)
  # ====================================================================
  test-python-modules: # underutilized VMs Mock Test 
    name: 'Quality Gate: Python Unit Tests'
    needs: lint-workflows
    uses: ./.github/workflows/3.1-python-tests.yml

  test-report: # JOB-ID wurde umbenannt
    name: 'Quality Gate: Test Report Generation'
    # 'needs' muss jetzt auf die neue, nummerierte Job-ID verweisen.
    needs: lint-workflows
    uses: ./.github/workflows/3-mock-test-report-generation.yml
    secrets: inherit

  # ====================================================================
  # JOB 3: AZURE-ANALYSE (Nummeriert für korrekte UI-Sortierung)
  # ====================================================================
  analyze-and-report: # JOB-ID wurde umbenannt
    name: 'Main Task: Analyze and Report'
    # 'needs' muss jetzt auf die neuen, nummerierten Job-IDs verweisen.
    needs: [lint-workflows, test-report, test-python-modules]
    uses: ./.github/workflows/1-analyze-and-report.yml
    secrets: inherit
